<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Demystifying Celery - Sam Clarke</title>

        <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
        <meta name="author" content="Hakim El Hattab">

        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/black.css" id="theme">

        <!-- Code syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">
    
        <!-- custom css -->
        <link rel="stylesheet" href="css/custom/style.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>

<div class="reveal">

<!-- Any section element inside of this container is displayed as a slide -->
<div class="slides">
<!-- Slide -->
<section>
<h1>Demystifying Celery</h1>
<p><small>Sam Clarke</small></p>
</section>

<!-- Slide -->
<section>
<h1>Template</h1>
</section>


<!--  ////////////////////////  INTRODUCTION  /////////////////////// -->
<!-- Slide -->
<section>
<h1>Who I am</h1>
<ul>
  <li>Technical Director @ <strong><span class="highlight">Rival Schools</span></strong></li>
  <li>Lead Developer &nbsp;&nbsp;&nbsp; @ <strong><span class="highlight">Script Speaker</span></strong></li>
</ul>
</section>

<!-- Slide -->
<section>
<h1>Who I am <strong>NOT</strong></h1>
<ul>
  <li>Not a core dev of Celery</li>
  <li>Not an expert</li>
</ul>
</section>

<!-- Slide -->
<section>
<h1>Celery</h1>
<!-- TODO: image fo celery stick transversely showing C shape.
joke: Core Devs missed an opportunity here for the logo...-->
<img class="no-border" src="" />
</section>

<!-- Slide -->
<section>
<img class="no-border" src="img/celery.png" />
</section>

<!-- Slide -->
<section>
<h1>Why this talk?</h1>
<ul>
  <li>New things are <span class="highlight">hard</span></li>
  <li>Distributed what?</li>
  <li>It's not just Python?</li>
</ul>
</section>

<!-- Slide -->
<section>
<h1>What is Celery?</h1>
<ul>
<li>Celery is written in Python.</li>
<li>Celery is a task queue.</li>
<li><span class="highlight">Django-Celery</span> is also a thing.</li>
</ul>
</section>

<!-- Slide -->
<section>
<h1>Do I need Celery?</h1>
<div class="template template-left">
<ul>
<li>Maybe you don't (your app is syncronous).</li>
<li>You have tasks which don't need to be executed <span class="highlight">syncronously</span>.</li>
<li>You are configuring your application for <span class="highlight">performance</span> where available resources are a concern.</li>
</ul>
</div>
</section>

<!-- Slide -->
<section>
<h1>Do I need Celery?</h1>
<p>Introducing Celery into your application is trade-off bewtween <span class="highlight">performance</span> and <span class="highlight">complexity</span>.</p>
</section>

<!-- Slide -->
<section>
<div class="template template-left">
<span class="highlight"><p>Celery is one of my go-to tools for any web app.</p> 
<p>Even apps of modest size can benefit from a task queue.</p></span>
</div>
</section>

<!-- Slide -->
<section>
<h1>How Does Celery work?</h1>
</section>

<section>
<h2>Celery Brokers</h2>
<div class="template template-left">
<ul>
<li>Celery communicates via <span class="highlight">messages</span>, usually using a <span class="highlight">broker</span> to mediate between clients and workers.</li>
<li>Common brokers are <span class="highlight">RabbitMQ, Redis</span>.</li>
</ul>
</div>
</section>

<section>
<h2>Celery Backends</h2>
<div class="template template-left">
<ul>
<li>Celery can store task state (optional) using a result <span class="highlight">backend</span>.</li>
<li>Common result backends include <span class="highlight">RabbitMQ, Redis, MemcacheD, SQL</span>.</li>
</ul>
</div>
</section>


<!--  ////////////////////////  SETTING UP CELERY  /////////////////////// -->
<!-- Slide -->
<section>
<h1>Setting Up Celery</h1>
</section>

<!-- Slide -->
<section>
<h2>Install system packages</h2>
<ul>
  <li>sudo <span class="highlight">apt-get</span> install rabbitmq-server (redis)</li>
  <li><span class="highlight">pip</span> install celery</li>
</ul>
</section>

<!-- Slide -->
<section>
<h1>Starting Celery</h1>
<p style='font-size: 28px'>celery worker --app <span class="highlight">app.celery</span> --concurrency 4 --loglevel=debug</p>
</section>

<!-- Slide -->
<section>
<h1>Workers & Concurrency</h1>
</section>

<!-- Slide -->
<section>
<h1>Instantiating Celery</h1>
</section>


<!-- Slide -->
<section>
<h2>Instantiating Celery</h2>
<!-- code -->
<pre><code data-trim>
#  app.py

from celery import Celery

celery = Celery(
    broker="amqp://guest@localhost//",
    backend="redis://localhost:6379/0"
)
</code></pre>

<p>or...</p>
</section>

<!-- Slide -->
<section>
<h2>Using a config file</h2>
<!-- code -->
<pre><code data-trim>
#  app.py

from celery import Celery

celery = Celery()
celery.config_from_object('celery_config')
</code></pre>

<pre><code data-trim>
#  celery_config.py

import os

BROKER_URL = os.environ['BROKER_URL']
CELERY_RESULT_BACKEND = os.environ['BROKER_BACKEND']
CELERYD_POOL_RESTARTS = True
...
</code></pre>
</section>

<!-- Slide -->
<section>
<h1>Registering Tasks</h1>
</section>

<!-- Slide -->
<section>
<h2>Regular Function</h2>
<!-- code -->
<pre><code data-trim>
def send_email(user_id):
    user = User.objects.get(id=user_id)
    subject = 'Welcome, {}'.format(user.username)
    body = 'Hello from Celery'
    send_email(user.email, subject, body)

#  call task synchronously
send_email(user_id=1234)
    </code></pre>
</section>

<!-- Slide -->
<section>
<h2>Celery Function</h2>
<!-- code -->
<pre><code data-trim>
@celery.task
def send_email(user_id):
    user = User.objects.get(id=user_id)
    subject = 'Welcome, {}'.format(user.username)
    body = 'Hello from Celery'
    send_email(user.email, subject, body)

#  call task asynchronously
send_email.delay(user_id=1234)
</code></pre>
</section>

<!-- Slide -->
<section>
<h2>Getting Results</h2>
<!-- code -->
<pre><code data-trim>
@celery.task
def add(x, y):
    retun x + y

#  This is not what you may expect...
result = add.delay(5, 7)
</code></pre>
</section>

<!-- Slide -->
<section>
<h2>Getting Results</h2>
<!-- code -->
<pre><code data-trim>
@celery.task
def add(x, y):
    retun x + y

#  We first get a reference to the task
task = add.delay(5, 7)

#  We don't know when our task will be ready...
#  Note: this is blocking code - DON'T DO THIS!
while not task.ready():
    time.sleep(1)

#  Now we can get our actual result
result = task.get()
</code></pre>
</section>

<!-- Slide -->
<section>
<h2>Getting Task Status</h2>
<pre><code data-trim>
from celery import Celery
from celery.result import AsyncResult

@celery.task
def add(x, y):
    retun x + y

#  get reference to task and keep it somewhere
task = add.delay(5, 7)
</code></pre>
<pre><code data-trim>
#  get task object by id
task = add.AsyncResult(task.id)

#  return result if task is finished
if task.ready():
    result = task.get()
    ...
else:
    #  do something else
    ...
</code></pre>
</section>

<!-- slide -->
<section>
<h2>Don't rely on state</h2>
<!-- code -->
<pre><code data-trim>
@celery.task
def send_email(user_id):
    user = User.objects.get(id=user_id)
    ...
    send_email(user.email, subject, body)


#  why not just pass in the user object?

send_email.delay(user_id=1234)

</code></pre>
</section>

<!-- slide -->
<section>
<h2>Useful Task methods</h2>
<ul>
  <li><span class="highlight">task.get()</span> - blocks until ready. Returns result or Exception.</li>
  <li><span class="highlight">task.successful()</span> - returns True or False</li>
  <li><span class="highlight">task.ready()</span> - returns True if task is done.</li>
  <li><span class="highlight">task.revoke()</span> - workers will ignore task. If terminate=True, execution is killed.
</ul>
</section>

<!-- Slide -->
<section>
<h2>Chaining Tasks</h2>
<p class="template template-left">A <span class="highlight">signature()</span> wraps the arguments, keyword arguments, and execution options of a single task invocation in a way such that it can be passed to functions.</p>
</section>

<!-- Slide -->
<section>
<h2>Chaining Tasks</h2>
<p><span class="highlight">s()</span> is a shortcut for <span class="highlight">signature()</span>, using star arguments.</p>
<!-- code -->
<pre><code data-trim>
#  the second task takes result of first task and 10 as args

tasks = chain(add.s(5, 7), add.s(10)).delay()



#  use ids to obtain each task object
#  you probably want to check task status
#  before calling task.result

result_one = add.AsyncResult(tasks.parent.id).result
result_two = add.AsyncResult(tasks.id).result
</code></pre>
</section>

<!-- Slide -->
<section>
<h1>Task Priority</h1>
<p class="template template-left highlight">"RabbitMQ supports priorities since version 3.5.0, and the Redis transport emulates priority support."</p>
<p class="template template-left">In Production, it is best to route high-priority tasks to dedicated workers.</p>
</section>



<!--  ////////////////////////  MONITORING AND TESTING  /////////////////////// -->
<!-- Slide -->
<section>
<h1>Logging</h1>
<ul>
  <li>Celery has its own logger wrapper.</li>
  <li>Your regular logs will get swallowed.</li>
</ul>
</section>

<!-- slide -->
<section>
<h2>Logging</h2>
<!-- code -->
<pre><code data-trim>
import logging
from flask import Flask
from celery.utils.log import get_task_logger
</code></pre>

<pre><code data-trim>
#  normal logging in FLASK

app = Flask(__name__)
handler = logging.StreamHandler()
app.logger.addHandler(handler)


#  CELERY logging

celery_logger = get_task_logger(__name__)
</code></pre>
</section>

<!-- Slide -->
<section>
<h1>Celery Flower</h1>
</section>

<!-- Slide -->
<section>
<h1>Munin</h1>
</section>


<!-- Slide -->
<section>
<h1>Testing</h1>
<p>You probably don't want to wait for your unit tests to execute.</p>
</section>

<!-- Slide -->
<section>
<h2>Testing Options</h2>
<ul>
  <li>Use Celery's <span class="highlight">ALWAYS_EAGER</span> mode.</li>
  <li>Use <span class="highlight">task.apply_async()</span> instead of <span class="highlight">task.delay()</span>.</li>
  <li>Django has it's own <span class="highlight">CeleryTestSuiteRunner</span>.</li>
</ul>
</section>


<!-- Slide -->
<section>
<h2>Distributing Workers</h2>
<ul>
<li>Add hosts address. TODO: clarify this.</li>
<li>Each host must have access to the task code <span class="highlight">locally</span>.</li>
</ul>
</section>


<!--  ////////////////////////  CELERY IN PRODUCTION  /////////////////////// -->
<section>
<h2>Daemonizing Celery</h2>
</section>

<!-- Slide -->
<section>
<h1>Conclusion</h1>
<div class="template template-left">
<ul>
<li>Don't send <span class="highlight">objects</span> to tasks. State can change.</li>
<li>Many <span class="highlight">small tasks</span> are better than one large one.
</li>
<li><span class="highlight">Don't block</span>. If you need to wait for the result it's not asychronous.</li>
</ul>
</div>
</section>

<!-- Slide -->
<section>
<h1>References</h1>
<ul>
  <li><a href="http://programeveryday.com/post/message-queues-python-and-celery/">http://programeveryday.com/post/message-queues-python-and-celery</a></li>
  <li><a href="https://denibertovic.com/posts/celery-best-practices/">https://denibertovic.com/posts/celery-best-practices/</a></li>
</li>
</section>


            </div>

        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>

            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                transition: 'slide', // none/fade/slide/convex/concave/zoom

                // Optional reveal.js plugins
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/notes/notes.js', async: true }
                ]
            });

        </script>

    </body>
</html>
